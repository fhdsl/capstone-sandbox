name: GHA Assignment Evaluation

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/workflows/ASSIGNMENT_2.yml'

jobs:
   gha-test:
    runs-on: ubuntu-latest
    container:
      image: maniator/gh

    steps:
      # Step 1: Checkout the files here.
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run the thing 
        run: gh workflow run .github/workflows/ASSIGNMENT_2.yml --ref ${{ github.head_ref }}
          
      - name: Wait and fetch workflow results
        id: check-results
        if: steps.check-location.outputs.correct_location == 'true'
        run: |
          sleep 90  # Wait for workflow to complete
          
          # Fixed: Use correct workflow filename
          WORKFLOW_ID=$(gh run list --workflow=ASSIGNMENT_2.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          STATUS=$(gh run view $WORKFLOW_ID --json conclusion --jq '.conclusion')
          
          echo "workflow_status=$STATUS" >> $GITHUB_OUTPUT
          
          # Download and analyze logs
          gh run download $WORKFLOW_ID --name logs || true
        env:
          GH_TOKEN: ${{ github.token }}
    
      - name: Install uv
        if: steps.check-results.outputs.workflow_status == 'success'
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        if: steps.check-results.outputs.workflow_status == 'success'
        run: | 
          uv pip install --system requests uuid

      - name: Generate secret code
        id: generate-code
        if: steps.check-results.outputs.workflow_status == 'success'
        run: |
          SECRET_CODE=$(python .github/workflows/scripts/generate_secret_code.py)
          echo "Generated Secret Code: $SECRET_CODE"
          echo "secret_code=$SECRET_CODE" >> $GITHUB_OUTPUT
        shell: bash

      # --- Comment on Pull Request (SUCCESS case) ---
      - name: Comment secret code on PR
        if: steps.check-results.outputs.workflow_status == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üéâ **GitHub Action Successful!** üéâ

            Great job! Your GitHub Action ran successfully.

            Please copy the following secret code and provide it to your Coursera course to prove completion:

            ```
            ${{ steps.generate-code.outputs.secret_code }}
            ```

            Keep up the excellent work!
          comment-id: docker-build-secret-code
          update-existing: true

      # --- Comment on Pull Request (FAILURE case) ---
      - name: Comment on PR (Failure)
        # Fixed: Reference the correct step and output
        if: steps.check-results.outputs.workflow_status != 'success' && steps.check-location.outputs.correct_location == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Learner Action Test Failed!** ‚ö†Ô∏è

            It looks like your GitHub Action test did not complete successfully.

            Please **review the Action logs for this workflow run** to identify and fix the issue. You can access the logs by clicking on the "Details" next to your failed test.

            Once you've resolved the problem, push your changes to this pull request, and the workflow will automatically re-run.

            Keep trying! You'll get it!
          comment-id: learner-action-secret-code-failure
          update-existing: true
