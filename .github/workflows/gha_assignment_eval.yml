name: GHA Assignment Evaluation

on:
  workflow_dispatch: 
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/workflows/GitHub_Action_Assignment.yml'

jobs:
   gha-test:
    runs-on: ubuntu-latest
    container:
      image: maniator/gh
    permissions:
      actions: read
      contents: read
      pull-requests: write

    steps:
      # Step 1: Checkout the files here.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install jq (required for JSON parsing)
      - name: Install jq
        run: |
          apk add jq

      - name: Check for recent successful runs
        id: check-results
        run: |
          WORKFLOW_STATUS="none"
          RECENT_SUCCESS=false

          # Look for workflow files that might match
          WORKFLOW_FILE=".github/workflows/GitHub_Action_Assignment.yml"

          echo "Checking for workflow at: $WORKFLOW_FILE"

          # Try to find the workflow using GitHub API
          WORKFLOW_INFO=$(gh api repos/${{ github.repository }}/actions/workflows 2>/dev/null | jq -r --arg path "$WORKFLOW_FILE" '.workflows[] | select(.path == $path) | .id' | head -1)

          if [ ! -z "$WORKFLOW_INFO" ] && [ "$WORKFLOW_INFO" != "null" ] && [ "$WORKFLOW_INFO" != "" ]; then
            echo "Found workflow with ID: $WORKFLOW_INFO"

            # Check for recent runs (last 7 days to be more forgiving)
            echo "Checking for recent workflow runs..."
            RECENT_RUNS=$(gh api "repos/${{ github.repository }}/actions/workflows/$WORKFLOW_INFO/runs?per_page=10" 2>/dev/null | jq -r '.workflow_runs[] | select(.created_at > "'$(date -d '7 days ago' -Iso8601)'") | {id: .id, status: .status, conclusion: .conclusion, created_at: .created_at, head_branch: .head_branch}')

            if [ ! -z "$RECENT_RUNS" ] && [ "$RECENT_RUNS" != "" ]; then
              echo "Found recent workflow runs:"
              echo "$RECENT_RUNS" | jq -c '.'

              # Check if any recent run was successful
              SUCCESS_COUNT=$(echo "$RECENT_RUNS" | jq -r 'select(.conclusion == "success") | .id' | wc -l)

              if [ "$SUCCESS_COUNT" -gt 0 ]; then
                WORKFLOW_STATUS="success"
                RECENT_SUCCESS=true
                echo "‚úÖ Found $SUCCESS_COUNT successful workflow run(s)"

                # Get the most recent successful run details
                LATEST_SUCCESS=$(echo "$RECENT_RUNS" | jq -r 'select(.conclusion == "success") | .created_at' | head -1)
                echo "Most recent success: $LATEST_SUCCESS"
              else
                # Check the status of the most recent run
                LATEST_STATUS=$(echo "$RECENT_RUNS" | jq -r '.conclusion // .status' | head -1)
                WORKFLOW_STATUS="$LATEST_STATUS"
                echo "Most recent run status: $WORKFLOW_STATUS"
              fi
            else
              echo "No recent workflow runs found (checked last 7 days)"
              WORKFLOW_STATUS="no_recent_runs"
            fi
          else
            echo "Could not find workflow in repository or workflow not yet registered"
            echo "This might happen if:"
            echo "1. The workflow file was just added and GitHub hasn't indexed it yet"
            echo "2. The workflow has never been triggered"
            echo "3. There's an issue with the workflow file"
            WORKFLOW_STATUS="not_indexed"
          fi

          echo "Final workflow_status: $WORKFLOW_STATUS"
          echo "workflow_status=$WORKFLOW_STATUS" >> $GITHUB_OUTPUT
          echo "recent_success=$RECENT_SUCCESS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Install Python and dependencies
        if: steps.check-results.outputs.workflow_status == 'success'
        run: |
          apk add --no-cache python3 py3-pip
          pip3 install requests uuid

      - name: Generate secret code
        id: generate-code
        if: steps.check-results.outputs.workflow_status == 'success'
        run: |
          SECRET_CODE=$(python .github/workflows/scripts/generate_secret_code.py)
          echo "Generated Secret Code: $SECRET_CODE"
          echo "secret_code=$SECRET_CODE" >> $GITHUB_OUTPUT
        shell: bash

      # --- Comment on Pull Request (SUCCESS case) ---
      - name: Comment secret code on PR
        if: steps.check-results.outputs.workflow_status == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üéâ **GitHub Action Successful!** üéâ

            Great job! Your GitHub Action ran successfully.

            Please copy the following secret code and provide it to your Coursera course to prove completion:

            ```
            ${{ steps.generate-code.outputs.secret_code }}
            ```

            Keep up the excellent work!
          comment-id: docker-build-secret-code
          update-existing: true

      # --- Comment on Pull Request (INVALID WORKFLOW case) ---
      - name: Comment on invalid workflow
        if: steps.validate-workflow.outputs.workflow_exists == 'true' && steps.validate-workflow.outputs.workflow_valid == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Invalid Workflow YAML** ‚ö†Ô∏è

            Your workflow file exists at `.github/workflows/GitHub_Action_Assignment.yml`, but it contains invalid YAML syntax.

            Please check your workflow file for:
            - Proper indentation (use spaces, not tabs)
            - Missing colons or quotes
            - Incorrect YAML structure

            You can validate your YAML online at https://yamlchecker.com/ or use a YAML validator in your IDE.

            Once you fix the YAML syntax, push your changes and the evaluation will run automatically!
            If you want to retrigger a evaluation you can go to the Actions tab to do a manual dispatch.
          comment-id: invalid-workflow-yaml
          update-existing: true

      # --- Comment on Pull Request (NO RUNS case) ---
      - name: Comment on no workflow runs
        if: steps.check-results.outputs.workflow_status == 'no_recent_runs' || steps.check-results.outputs.workflow_status == 'not_indexed'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **No Recent Workflow Runs Found** ‚ö†Ô∏è

            Your workflow file exists at `.github/workflows/GitHub_Action_Assignment.yml`, but I haven't found any successful runs in the last 7 days.

            **This could mean:**
            1. Your workflow hasn't been triggered yet
            2. Your workflow doesn't have the right triggers to run automatically
            3. Your workflow has errors that prevent it from running

            **To get your workflow running:**
            1. Make sure your workflow has triggers like:
               ```yaml
               on:
                 push:
                   branches: [ main ]
                 pull_request:
                   branches: [ main ]
               ```
            2. Try making a small change to your repository (like editing this comment or adding a space to a file) to trigger the workflow
            3. Check the "Actions" tab in your repository to see if there are any workflow runs

            If you push new commits, I'll automatically evaluate and detect your workflow run status. 
            If you want to retrigger a evaluation you can go to the Actions tab to do a manual dispatch. 
          comment-id: no-workflow-runs
          update-existing: true

      # --- Comment on Pull Request (FAILURE case) ---
      - name: Comment on PR (Failure)
        if: steps.check-results.outputs.workflow_status != 'success' && steps.check-results.outputs.workflow_status != 'no_recent_runs' && steps.check-results.outputs.workflow_status != 'not_indexed'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Workflow Run Failed** ‚ö†Ô∏è

            Your workflow file exists and is valid, but the most recent run failed with status: `${{ steps.check-results.outputs.workflow_status }}`

            **Next steps:**
            1. Check the Actions tab in your repository to see the detailed logs
            2. Look for error messages in the failed workflow run
            3. Fix any issues in your workflow or the code it's trying to run
            4. Push your changes to trigger another run

            After each new commit, the evaluation will automatically update! 
            If you want to retrigger a evaluation you can go to the Actions tab to do a manual dispatch. 

            Keep trying! You'll get it! üí™
          comment-id: learner-action-secret-code-failure
          update-existing: true
