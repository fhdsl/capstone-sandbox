name: GHA Assignment Evaluation

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - 'ASSIGNMENT_2/ASSIGNMENT_2.yml'
      - '.github/workflows/ASSIGNMENT_2.yml'

jobs:
   gha-test:
    runs-on: ubuntu-latest
    container:
      image: python:3.9.23-slim

    steps:
      # Step 1: Checkout the files here.
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check workflow file location
        id: check-location
        run: |
          WORKFLOW_IN_CORRECT_LOCATION=false
          WORKFLOW_IN_WRONG_LOCATION=false
          
          # Check if workflow file exists in correct location
          if find .github/workflows/ -name "*ASSIGNMENT_2*" -type f \( -name "*.yml" -o -name "*.yaml" \) 2>/dev/null | grep -q .; then
            echo "‚úÖ Workflow file found in .github/workflows/"
            WORKFLOW_IN_CORRECT_LOCATION=true
          fi
          
          # Check if workflow file exists in assignment folder (wrong location)
          if find ASSIGNMENT_2/ -name "*.yml" -o -name "*.yaml" 2>/dev/null | grep -q .; then
            echo "‚ö†Ô∏è  Workflow file found in ASSIGNMENT_2/ folder"
            WORKFLOW_IN_WRONG_LOCATION=true
          fi
          
          echo "correct_location=$WORKFLOW_IN_CORRECT_LOCATION" >> $GITHUB_OUTPUT
          echo "wrong_location=$WORKFLOW_IN_WRONG_LOCATION" >> $GITHUB_OUTPUT
          
      - name: Comment on incorrect file location
        if: steps.check-location.outputs.wrong_location == 'true' && steps.check-location.outputs.correct_location == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **GitHub Action File Location Issue** ‚ö†Ô∏è
            
            It looks like you've created your GitHub Action workflow file, but it's in the wrong location!
            
            **Current location:** `ASSIGNMENT_2/ASSIGNMENT_2.yml` ‚ùå
            **Required location:** `.github/workflows/ASSIGNMENT_2.yml` ‚úÖ
            
            **To fix this:**
            1. Create a `.github/workflows/` folder in your repository root (if it doesn't exist)
            2. Move your `ASSIGNMENT_2.yml` file from the `ASSIGNMENT_2/` folder to `.github/workflows/`
            3. Your final file should be at: `.github/workflows/ASSIGNMENT_2.yml`
            
            GitHub Actions only run when workflow files are placed in the `.github/workflows/` directory. Once you move the file to the correct location, your action should start running automatically!
            
            üí° **Tip:** You can also rename the file to something more descriptive like `assignment-2-workflow.yml` if you prefer.
          comment-id: workflow-location-warning
          
      - name: Stop evaluation if file in wrong location
        if: steps.check-location.outputs.correct_location == 'false'
        run: |
          echo "::error::Workflow file not found in .github/workflows/ directory"
          echo "Cannot proceed with evaluation until workflow file is in correct location"
          exit 1

      # Step 2: Test run the workflow
      - name: Trigger student workflow
        id: trigger-workflow
        if: steps.check-location.outputs.correct_location == 'true'
        run: |
          # Create a simple trigger file or event
          echo "Triggering student workflow..."
          # Fixed: workflows (plural) and correct filename reference
          gh workflow run .github/workflows/ASSIGNMENT_2.yml --ref ${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Wait and fetch workflow results
        id: check-results
        if: steps.check-location.outputs.correct_location == 'true'
        run: |
          sleep 30  # Wait for workflow to complete
          
          # Fixed: Use correct workflow filename
          WORKFLOW_ID=$(gh run list --workflow=ASSIGNMENT_2.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          STATUS=$(gh run view $WORKFLOW_ID --json conclusion --jq '.conclusion')
          
          echo "workflow_status=$STATUS" >> $GITHUB_OUTPUT
          
          # Download and analyze logs
          gh run download $WORKFLOW_ID --name logs || true

      - name: Install uv
        if: steps.check-results.outputs.workflow_status == 'success'
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        if: steps.check-results.outputs.workflow_status == 'success'
        run: | 
          uv pip install --system requests uuid

      - name: Generate secret code
        id: generate-code
        if: steps.check-results.outputs.workflow_status == 'success'
        run: |
          SECRET_CODE=$(python .github/workflows/scripts/generate_secret_code.py)
          echo "Generated Secret Code: $SECRET_CODE"
          echo "secret_code=$SECRET_CODE" >> $GITHUB_OUTPUT
        shell: bash

      # --- Comment on Pull Request (SUCCESS case) ---
      - name: Comment secret code on PR
        if: steps.check-results.outputs.workflow_status == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üéâ **GitHub Action Successful!** üéâ

            Great job! Your GitHub Action ran successfully.

            Please copy the following secret code and provide it to your Coursera course to prove completion:

            ```
            ${{ steps.generate-code.outputs.secret_code }}
            ```

            Keep up the excellent work!
          comment-id: docker-build-secret-code
          update-existing: true

      # --- Comment on Pull Request (FAILURE case) ---
      - name: Comment on PR (Failure)
        # Fixed: Reference the correct step and output
        if: steps.check-results.outputs.workflow_status != 'success' && steps.check-location.outputs.correct_location == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Learner Action Test Failed!** ‚ö†Ô∏è

            It looks like your GitHub Action test did not complete successfully.

            Please **review the Action logs for this workflow run** to identify and fix the issue. You can access the logs by clicking on the "Details" next to your failed test.

            Once you've resolved the problem, push your changes to this pull request, and the workflow will automatically re-run.

            Keep trying! You'll get it!
          comment-id: learner-action-secret-code-failure
          update-existing: true
